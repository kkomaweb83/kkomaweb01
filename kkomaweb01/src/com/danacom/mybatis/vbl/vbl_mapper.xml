<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.danacom.mybatis.vbl.vbl_mapper">
	
	<select id="vblList" resultType="com.danacom.mybatis.vbl.VirBillVo" parameterType="hashmap">
		SELECT 
			t2.*
		FROM
		(
		SELECT 
			t1.*
			, ROWNUM rm
			, COUNT(VBL_NO) OVER() AS tot_cont
		FROM
		(
			SELECT 
				VBL_NO
				, VBL_MEM_NO
				, VBL_BOR_ANSWER
				, VBL_TITLE
				, TO_CHAR(VBL_DATE, 'YYYY/MM/DD') VBL_DATE
			FROM VIR_BILL
			WHERE VBL_MEM_NO = #{vbl_mem_no}
			ORDER BY VBL_NO DESC
		) t1
		) t2
		WHERE rm BETWEEN #{begin} AND #{end}
	</select>
	
	<select id="vblMaxNo" resultType="int">
		SELECT NVL(MAX(VBL_NO), 0)+1 FROM VIR_BILL
	</select>
	
	<insert id="vblInsert" parameterType="com.danacom.mybatis.vbl.VirBillVo">
		INSERT 
		INTO VIR_BILL
		(VBL_NO, VBL_MEM_NO, VBL_BOR_ANSWER, VBL_TITLE, VBL_DATE)
		VALUES
		(#{vbl_no}, #{vbl_mem_no}, #{vbl_bor_answer}, #{vbl_title}, SYSDATE)
	</insert>	
	
	<insert id="vdtInsert" parameterType="com.danacom.mybatis.vbl.VblDetVo">
		INSERT 
		INTO VBL_DET
		(VDT_NO, VDT_VBL_NO, VDT_QUANTITY, VDT_PRO_NO)
		VALUES
		((SELECT NVL(MAX(VDT_NO), 0)+1 FROM VBL_DET)
		, #{vdt_vbl_no}, #{vdt_quantity}, #{vdt_pro_no})
	</insert>
	
	<select id="vblVo" resultType="com.danacom.mybatis.vbl.VirBillVo" parameterType="int">
		SELECT 
			VBL_NO, VBL_MEM_NO, VBL_BOR_ANSWER
			, VBL_TITLE
			, TO_CHAR(VBL_DATE, 'YYYY/MM/DD') VBL_DATE
		FROM VIR_BILL
		WHERE VBL_NO = #{vbl_no}
		AND ROWNUM = 1
	</select>
	
	<select id="vblProVo" resultType="com.danacom.mybatis.pro.ProductVo" parameterType="com.danacom.mybatis.pcl.ProClassVo">
		SELECT 
			PRO_NO, PRO_DISPRICE
			, TO_CHAR(PRO_DISPRICE, '999,999,999,999')||'원' PRO_CH_PRICE
			, TO_CHAR(PRO_DISPRICE, '999,999,999,999') PRO_CH2_PRICE
			, PRO_PCL_NO
			, PRO_NAME
			, VDT_QUANTITY AS PST_QUANTITY
		FROM PRODUCT, VBL_DET 
		WHERE VDT_PRO_NO = PRO_NO AND VDT_VBL_NO = #{ppt_no} 
		AND PRO_NO IN (SELECT VDT_PRO_NO FROM VBL_DET WHERE VDT_VBL_NO = #{ppt_no}) 
		AND PRO_PCL_NO = #{pcl_no} 
	</select>
	
	<update id="vblUpdate" parameterType="com.danacom.mybatis.vbl.VirBillVo">
		UPDATE 
		VIR_BILL SET
			VBL_TITLE = #{vbl_title}
			, VBL_BOR_ANSWER = #{vbl_bor_answer}
		WHERE VBL_NO = #{vbl_no}	
	</update> 	
	
	<delete id="vdtDelete" parameterType="int">
		DELETE 
		FROM VBL_DET 
		WHERE VDT_VBL_NO = #{vblMaxNo}
	</delete>
	
	<delete id="vblDelete" parameterType="int">
		DELETE 
		FROM VIR_BILL
		WHERE VBL_NO = #{vblMaxNo}
	</delete>
	
	<select id="vbbMaxNo" resultType="int">
		SELECT NVL(MAX(VBB_NO), 0)+1 FROM VIR_BILL_BOARD
	</select>
	
	<insert id="vbbInsert" parameterType="com.danacom.mybatis.vbl.VirBillVo">
		INSERT 
		INTO VIR_BILL_BOARD
		(VBB_NO, VBB_CONTENT, VBB_MEM_NO, VBB_DATE, VBB_RECOMM
		, VBB_COUNT, VBB_BTR_ANSWER, VBB_TITLE)
		VALUES
		(#{vbb_no}, #{vbl_title}, #{vbl_mem_no}, SYSDATE, 0, 0, 'n', #{vbl_title})
	</insert>
	
	<insert id="vdsInsert" parameterType="com.danacom.mybatis.vbl.VblDetVo">
		INSERT 
		INTO VBL_DET_SHARE
		(VDS_NO, VDS_VBB_NO, VDS_QUANTITY, VDS_PRO_NO)
		VALUES
		((SELECT NVL(MAX(VDS_NO), 0)+1 FROM VBL_DET_SHARE)
		, #{vds_vbb_no}, #{vdt_quantity}, #{vdt_pro_no})
	</insert>
	
	<select id="vbbList" resultType="com.danacom.mybatis.vbl.VbbVo" parameterType="hashmap">
		SELECT 
			t2.*
		FROM
		(
		SELECT 
			t1.*
			, ROWNUM rm
			, COUNT(vbb_no) OVER() AS tot_cont
		FROM
		(
			select 
				vbb.vbb_no, vbb.vbb_content, mem.mem_id,
				to_char(vbb.vbb_date, 'yyyy-mm-dd') as vbb_date,
				vbb.vbb_recomm, vbb.vbb_count, vbb.vbb_btr_answer, vbb.vbb_title
			from vir_bill_board vbb, mem_com mem 
			where vbb.vbb_mem_no = mem.mem_no
			order by vbb.vbb_no desc
		) t1
		) t2
		WHERE rm BETWEEN #{begin} AND #{end}
	</select>
	
	<update id="countUpVbbContent" parameterType="com.danacom.mybatis.vbl.VbbVo">
		update 
		vir_bill_board
		set
			vbb_count = vbb_count + 1
		where vbb_no = #{vbb_no}
	</update>
	
	<select id="getVbbContent" resultType="com.danacom.mybatis.vbl.VbbVo" parameterType="com.danacom.mybatis.vbl.VbbVo">
		select
			vbb.vbb_no,
			vbb.vbb_content,
			mem.mem_id,
			to_char(vbb.vbb_date, 'yyyy-mm-dd') as vbb_date,
			vbb.vbb_recomm,
			vbb.vbb_count,
			vbb.vbb_btr_answer,
			vbb.vbb_title
		from vir_bill_board vbb
			join mem_com mem on vbb.vbb_mem_no = mem.mem_no
		where vbb.vbb_no = #{vbb_no}
		order by vbb.VBB_NO desc
	</select>
	
	<select id="getVbbContentPro" resultType="com.danacom.mybatis.vbl.VbsVo" parameterType="com.danacom.mybatis.vbl.VbbVo">
		select 
			VDS.VDS_NO,
			VDS.VDS_QUANTITY,
			PRO.PRO_NO,
			PRO.PRO_NAME,
			TO_CHAR(PRO.PRO_DISPRICE,'L9,999,999') PRO_DISPRICE,
			PRO.PRO_MILEGE,
			to_char(PRO.PRO_REGDATE, 'yyyy-mm-dd') pro_regdate,
			MKR.MKR_NAME,
			PCL.PCL_NAME,
			PCL.PCL_NO,
			PSM.PSM_CONENT,
			PMG.PMG_FILE
		FROM VBL_DET_SHARE VDS
			JOIN PRODUCT PRO ON VDS.VDS_PRO_NO = PRO.PRO_NO
			JOIN MAKER MKR ON PRO.PRO_MKR_NO = MKR.MKR_NO
			JOIN PRO_CLASS PCL ON PRO.PRO_PCL_NO = PCL.PCL_NO
			JOIN PRO_SUMM PSM ON PRO.PRO_NO = PSM.PSM_PRO_NO
			JOIN PRO_IMG PMG ON PRO.PRO_NO = PMG.PMG_PRO_NO
		where vds_vbb_no = #{vbb_no}
			and pmg.pmg_idt_no = 1
		order by pcl.pcl_no
	</select>
	
	<select id="getVbrList" resultType="com.danacom.mybatis.vbl.VbbVo" parameterType="com.danacom.mybatis.vbl.VbbVo">
		select 
			vbr.VBR_NO,
			vbr.VBR_CONTENT,
			to_char(vbr.VBR_RDATE, 'yyyy-mm-dd') VBR_RDATE,
			vbr.VBR_TITLE,
			mem.mem_id
		from vbb_reply vbr
		join mem_com mem on vbr.vbr_mem_no = mem.mem_no 
		where VBR_VBB_NO = #{vbb_no}
		order by vbr.vbr_no desc
	</select>
	
	<update id="recommVbbContent" parameterType="com.danacom.mybatis.vbl.VbbVo">
		update 
		vir_bill_board
		set
			vbb_recomm = vbb_recomm + 1
		where vbb_no = #{vbb_no}
	</update>
	
	<insert id="replyInsert" parameterType="com.danacom.mybatis.vbl.VbbVo">
		insert 
		into VBB_REPLY
			(vbr_no
			,vbr_content
			,vbr_rdate
			,vbr_vbb_no
			,vbr_mem_no
			,vbr_title)
		values
			((select nvl(max(vbr_no),0)+1 from vbb_reply)
			,#{vbr_content}
			,sysdate
			,#{vbb_no}
			,#{mem_no}
			,'사용안함')
	</insert>
	
	<delete id="replyDelete" parameterType="com.danacom.mybatis.vbl.VbbVo">
		delete 
		from vbb_reply
		where vbr_no=#{vbr_no}
	</delete>
	
	<update id="replyUpdate" parameterType="com.danacom.mybatis.vbl.VbbVo">
		update 
		vbb_reply set
			vbr_content = #{vbr_content}
		where vbr_no=#{vbr_no}
	</update>
	
</mapper>